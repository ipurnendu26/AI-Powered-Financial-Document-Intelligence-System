<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìä Financial Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #e0e7ff 0%, #f0fff4 100%);
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
    }
    h2, h5 {
      color: #4c51bf;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    canvas {
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(76,81,191,0.06);
    }
    .card {
      border: 1.5px solid #e3e8ee;
      border-radius: 16px;
      box-shadow: 0 6px 24px rgba(44, 62, 80, 0.08);
      transition: box-shadow 0.2s, border 0.2s, transform 0.2s;
      background: #fff;
    }
    .card:hover {
      transform: scale(1.01);
      box-shadow: 0 10px 32px rgba(44, 62, 80, 0.13);
      border: 1.5px solid #7f9cf5;
    }
    .navbar {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      background: linear-gradient(90deg, #4c51bf 0%, #38b2ac 100%) !important;
      border-bottom: 2px solid #b2f5ea;
    }
    .navbar-brand {
      color: #fff !important;
      font-weight: 600;
      letter-spacing: 0.5px;
      font-size: 1.2rem;
    }
    .navbar-brand:hover {
      color: #b2f5ea !important;
    }
    .form-control, .form-select {
      border-radius: 8px;
      border: 1.5px solid #c3dafe;
      transition: border 0.2s;
    }
    .form-control:focus, .form-select:focus {
      border-color: #4c51bf;
      box-shadow: 0 0 0 2px #b2f5ea44;
    }
    .btn-primary {
      background: linear-gradient(90deg, #4c51bf 0%, #38b2ac 100%);
      border: none;
      font-weight: 600;
      letter-spacing: 0.5px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(76,81,191,0.08);
      transition: background 0.2s, box-shadow 0.2s;
    }
    .btn-primary:hover {
      background: linear-gradient(90deg, #38b2ac 0%, #4c51bf 100%);
      box-shadow: 0 4px 16px rgba(56,178,172,0.13);
    }
    .btn-outline-secondary {
      border-radius: 8px;
      border: 1.5px solid #c3dafe;
      color: #4c51bf;
      font-weight: 600;
      background: #f7fafc;
      transition: background 0.2s, color 0.2s, border 0.2s;
    }
    .btn-outline-secondary:hover {
      background: #e0e7ff;
      color: #2b6cb0;
      border-color: #4c51bf;
    }
    .export-btn {
      float: right;
      margin-top: -38px;
    }
    .table thead {
      background-color: #ebf4ff;
    }
    .accordion-button {
      font-weight: bold;
      font-size: 1.1rem;
      background: linear-gradient(90deg, #e0e7ff 0%, #b2f5ea 100%);
      color: #4c51bf;
    }
    .accordion-button:not(.collapsed) {
      background: linear-gradient(90deg, #b2f5ea 0%, #e0e7ff 100%);
      color: #2b6cb0;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary px-4">
    <a class="navbar-brand" href="/">üìÑ Upload</a>
    <a class="navbar-brand" href="/dashboard">üìä Dashboard</a>
  </nav>

  <div class="container my-4">
    <!-- Dashboard Subtabs -->
    <ul class="nav nav-tabs" id="dashboardTabs">
      <li class="nav-item">
        <button class="nav-link active" id="visual-tab" data-bs-toggle="tab" data-bs-target="#visual" type="button" role="tab" aria-controls="visual" aria-selected="true">üìà Visualizations</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="recent-tab" data-bs-toggle="tab" data-bs-target="#recent" type="button" role="tab" aria-controls="recent" aria-selected="false">üïì Recent Transactions</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="false">üìÖ Yearly & Monthly Summary</button>
      </li>
    </ul>

    <div class="tab-content pt-4">
      <!-- Visualizations Tab -->
      <div class="tab-pane fade show active" id="visual" role="tabpanel" aria-labelledby="visual-tab">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <label class="mb-0" for="startDate">From:</label>
            <input type="date" id="startDate" class="form-control" style="max-width: 150px;" />
            <label class="mb-0" for="endDate">To:</label>
            <input type="date" id="endDate" class="form-control" style="max-width: 150px;" />
            <label class="mb-0" for="categoryFilter">Category:</label>
            <select id="categoryFilter" class="form-select" style="max-width: 150px;"></select>
            <label class="mb-0" for="merchantFilter">Merchant:</label>
            <select id="merchantFilter" class="form-select" style="max-width: 150px;"></select>
            <label class="mb-0" for="sourceFilter">Source:</label>
            <select id="sourceFilter" class="form-select" style="max-width: 120px;"></select>
            <button class="btn btn-primary ms-2" onclick="loadDashboard()">Apply</button>
            <button class="btn btn-outline-secondary ms-1" onclick="resetFilters()">Reset</button>
          </div>
        </div>
        <div class="row mt-4">
          <div class="col-md-6 mb-4">
            <div class="card p-3">
              <h5>üßæ Category-wise Spending</h5>
              <canvas id="categoryChart"></canvas>
            </div>
          </div>
          <div class="col-md-6 mb-4">
            <div class="card p-3">
              <h5>üìÜ Daily Spending Trend</h5>
              <canvas id="dailyChart"></canvas>
            </div>
          </div>
          <div class="col-md-6 mb-4">
            <div class="card p-3">
              <h5>üì• Source of Transactions</h5>
              <canvas id="sourceChart"></canvas>
            </div>
          </div>
          <div class="col-md-6 mb-4">
            <div class="card p-3">
              <h5>üè™ Top Merchants</h5>
              <canvas id="merchantChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Transactions Tab -->
      <div class="tab-pane fade" id="recent" role="tabpanel" aria-labelledby="recent-tab">
        <div class="card p-3">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-2 gap-2">
            <h5 class="mb-0">üïì Recent Transactions</h5>
            <input type="text" id="searchInput" class="form-control" style="max-width: 250px;" placeholder="Search by keyword, merchant, or amount..." oninput="loadTable()" />
          </div>
          <div class="table-responsive">
            <table class="table table-bordered table-sm">
              <thead><tr><th>Date</th><th>Name</th><th>Category</th><th>Amount</th><th>Source</th></tr></thead>
              <tbody id="recentTable"></tbody>
            </table>
          </div>
          <button class="btn btn-secondary mt-2" onclick="exportToCSV()">Export CSV</button>
        </div>
      </div>

      <!-- Yearly & Monthly Summary Tab -->
      <div class="tab-pane fade" id="summary" role="tabpanel" aria-labelledby="summary-tab">
        <div class="card p-3">
          <h5>üìÖ Yearly & Monthly Category-wise Totals</h5>
          <div class="accordion" id="yearlyAccordion"></div>
        </div>
      </div>
    </div>
  </div>

  <script>

    // Helper to build query params for all filters
    function getFilterParams() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      const category = document.getElementById('categoryFilter').value;
      const merchant = document.getElementById('merchantFilter').value;
      const source = document.getElementById('sourceFilter').value;
      let params = [];
      if (start) params.push(`start_date=${encodeURIComponent(start)}`);
      if (end) params.push(`end_date=${encodeURIComponent(end)}`);
      if (category && category !== 'All') params.push(`category=${encodeURIComponent(category)}`);
      if (merchant && merchant !== 'All') params.push(`merchant=${encodeURIComponent(merchant)}`);
      if (source && source !== 'All') params.push(`source=${encodeURIComponent(source)}`);
      return params.length ? '?' + params.join('&') : '';
    }

    function getSearchParam() {
      const search = document.getElementById('searchInput')?.value.trim();
      return search ? `&search=${encodeURIComponent(search)}` : '';
    }

    async function loadChart(url, chartId, type, label, colors) {
      const res = await fetch(url + getFilterParams());
      const data = await res.json();
      const ctx = document.getElementById(chartId);
      if (ctx.chart) ctx.chart.destroy();
      ctx.chart = new Chart(ctx, {
        type,
        data: {
          labels: data.labels,
          datasets: [{ label, data: data.values, backgroundColor: colors }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    }

    async function loadTable() {
      let url = '/api/recent' + getFilterParams() + getSearchParam();
      // Remove ?& if both present
      url = url.replace('?&', '?');
      const res = await fetch(url);
      const data = await res.json();
      const table = document.getElementById('recentTable');
      table.innerHTML = '';
      data.forEach(r => {
        // Simple search filter (client-side fallback)
        const search = document.getElementById('searchInput')?.value.trim().toLowerCase();
        if (search && !(
          (r.name && r.name.toLowerCase().includes(search)) ||
          (r.category && r.category.toLowerCase().includes(search)) ||
          (r.merchant && r.merchant.toLowerCase().includes(search)) ||
          (r.amount && r.amount.toString().includes(search)) ||
          (r.source && r.source.toLowerCase().includes(search))
        )) return;
        table.innerHTML += `<tr><td>${r.date}</td><td>${r.name}</td><td>${r.category}</td><td>${r.amount}</td><td>${r.source}</td></tr>`;
      });
    }

    async function loadYearlyMonthlySummary() {
      const yearly = await fetch('/api/summary/yearly').then(r => r.json());
      const monthly = await fetch('/api/summary/monthly').then(r => r.json());

      const container = document.getElementById("yearlyAccordion");
      container.innerHTML = '';

      const monthNames = [ "", "January", "February", "March", "April", "May", "June",
                          "July", "August", "September", "October", "November", "December" ];

      Object.keys(yearly).sort((a, b) => b - a).forEach((year, index) => {
        const collapseId = `collapse${year}`;
        const headingId = `heading${year}`;

        let monthsHTML = '';
        const months = monthly[year] || {};

        Object.keys(months).sort((a, b) => b - a).forEach(month => {
          const categories = months[month];
          const monthName = monthNames[month];

          let tableRows = '';
          Object.entries(categories).forEach(([cat, amt]) => {
            tableRows += `<tr><td>${cat}</td><td>‚Çπ ${amt.toFixed(2)}</td></tr>`;
          });

          monthsHTML += `
            <div class="mt-3">
              <h6 class="text-primary">${monthName}</h6>
              <div class="table-responsive">
                <table class="table table-sm table-bordered">
                  <thead><tr><th>Category</th><th>Amount</th></tr></thead>
                  <tbody>${tableRows}</tbody>
                </table>
              </div>
            </div>
          `;
        });

        container.innerHTML += `
          <div class="accordion-item">
            <h2 class="accordion-header" id="${headingId}">
              <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button"
                      data-bs-toggle="collapse" data-bs-target="#${collapseId}"
                      aria-expanded="${index === 0}" aria-controls="${collapseId}">
                üìÖ ${year} Category Totals
              </button>
            </h2>
            <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}"
                 aria-labelledby="${headingId}" data-bs-parent="#yearlyAccordion">
              <div class="accordion-body">
                ${monthsHTML || '<p class="text-muted">No data available</p>'}
              </div>
            </div>
          </div>
        `;
      });
    }

    async function loadDashboard() {
      loadChart('/api/summary/category', 'categoryChart', 'bar', 'Amount by Category', [
        '#4c51bf','#2b6cb0','#2c7a7b','#d69e2e','#c53030','#38a169','#805ad5','#ed8936']);
      loadChart('/api/summary/daily', 'dailyChart', 'line', 'Daily Total Amount', '#2b6cb0');
      loadChart('/api/summary/source', 'sourceChart', 'pie', 'Source Split', [
        '#3182ce', '#e53e3e', '#38a169', '#dd6b20']);
      loadChart('/api/summary/merchant', 'merchantChart', 'doughnut', 'Top Merchants', [
        '#805ad5', '#f56565', '#ed8936', '#48bb78', '#4299e1']);
      loadTable();
      loadYearlyMonthlySummary();
      populateFilterDropdowns();
    }

    function exportToCSV() {
      const table = document.getElementById('recentTable');
      const rows = [['Date', 'Name', 'Category', 'Amount', 'Source']];
      for (const tr of table.rows) {
        rows.push([...tr.cells].map(td => td.textContent));
      }
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Recent_Transactions");
      XLSX.writeFile(wb, "dashboard_data.xlsx");
    }

    // Populate filter dropdowns for category, merchant, source
    async function populateFilterDropdowns() {
      // Fetch unique values from backend endpoints (or use cached data)
      const [catRes, merchRes, srcRes] = await Promise.all([
        fetch('/api/summary/category'),
        fetch('/api/summary/merchant'),
        fetch('/api/summary/source')
      ]);
      const categories = (await catRes.json()).labels || [];
      const merchants = (await merchRes.json()).labels || [];
      const sources = (await srcRes.json()).labels || [];

      const catSel = document.getElementById('categoryFilter');
      const merchSel = document.getElementById('merchantFilter');
      const srcSel = document.getElementById('sourceFilter');

      catSel.innerHTML = '<option>All</option>' + categories.map(c => `<option>${c}</option>`).join('');
      merchSel.innerHTML = '<option>All</option>' + merchants.map(m => `<option>${m}</option>`).join('');
      srcSel.innerHTML = '<option>All</option>' + sources.map(s => `<option>${s}</option>`).join('');
    }

    function resetFilters() {
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('categoryFilter').value = 'All';
      document.getElementById('merchantFilter').value = 'All';
      document.getElementById('sourceFilter').value = 'All';
      loadDashboard();
      if(document.getElementById('searchInput')) document.getElementById('searchInput').value = '';
    }

    window.onload = loadDashboard;
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
